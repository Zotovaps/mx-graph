<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript">
        mxBasePath = '../src';
    </script>

    <!-- Loads and initializes the library -->
    <script type="text/javascript" src="../src/js/mxClient.js"></script>

    <script type="text/javascript">
        function main(container) {
            let count = 0;

            const json = {
                "boxes": [
                    {
                        "id": "box_rows_columns_example",
                        "header": {
                            "caption": "Test",
                            "position": {
                                "top": 10,
                                "left": 100
                            },
                            "size": {
                                "width": 345,
                                "height": 523
                            }
                        },
                        "body": {
                            "rows": [
                                {
                                    "columns": [
                                        {
                                            "item": {
                                                "box_id": "item1",
                                                "caption": "aaa",
                                                "box_links": [
                                                    {
                                                        "link": {
                                                            "typelink": 1,
                                                            "box_id": "box_json_example:item1"
                                                        }
                                                    }
                                                ]
                                            }
                                        },
                                        {
                                            "item": {
                                                "box_id": "item2",
                                                "caption": "bbb",
                                                "box_links": [
                                                    {
                                                        "link": {
                                                            "typelink": 1,
                                                            "box_id": "box_json_example:item1"
                                                        }
                                                    }
                                                ]
                                            }
                                        },
                                        {
                                            "item": {
                                                "box_id": "item3",
                                                "caption": "ccc",
                                                "box_links": [
                                                    {
                                                        "link": {
                                                            "typelink": 1,
                                                            "box_id": "box_json_example:item1"
                                                        }
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                },
                                {
                                    "columns": [
                                        {
                                            "item": {
                                                "box_id": "item11",
                                                "caption": "ddd",
                                                "box_links": [
                                                    {
                                                        "link": {
                                                            "typelink": 1,
                                                            "box_id": "box_json_example:item1"
                                                        }
                                                    }
                                                ]
                                            }
                                        },
                                        {
                                            "item": {
                                                "box_id": "item22",
                                                "caption": "eee",
                                                "box_links": [
                                                    {
                                                        "link": {
                                                            "typelink": 1,
                                                            "box_id": "box_json_example:item1"
                                                        }
                                                    }
                                                ]
                                            }
                                        },
                                        {
                                            "item": {
                                                "box_id": "item33",
                                                "caption": "fff",
                                                "box_links": [
                                                    {
                                                        "link": {
                                                            "typelink": 1,
                                                            "box_id": "box_json_example:item1"
                                                        }
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            ]
                        }
                    },
                    {
                        "id": "box_json_example",
                        "header": {
                            "caption": "Test2",
                            "position": {
                                "top": 10,
                                "left": 600
                            },
                            "size": {
                                "width": 345,
                                "height": 523
                            }
                        },
                        "body": {
                            "json": {
                                "type": "basket",
                                "beans": 47,
                                "apples": 7,
                                "oranges": 23,
                                "brand": "ConvertSimple",
                                "ratio": {
                                    "box_id": "item1"
                                },
                                "fees": {
                                    "cleaning": "$4.50",
                                    "baking": "$27.30",
                                    "commission": {
                                        "box_links": [
                                            {
                                                "link": {
                                                    "typelink": 2,
                                                    "box_id": "box_rows_columns_example:item1"
                                                }
                                            }
                                        ]
                                    },
                                    "descriptors": [
                                        "clean",
                                        "fresh",
                                        "juicy",
                                        "delicious"
                                    ]
                                }
                            }
                        }
                    }
                ]
            }

            var doc = document.implementation.createDocument("", "", null);
            var customMxGraphModel = doc.createElement("mxGraphModel");

            var root = doc.createElement("root");
            var mxCell0 = doc.createElement("mxCell");
            mxCell0.setAttribute("id", (count++).toString());

            var mxCell1 = doc.createElement("mxCell");
            mxCell1.setAttribute("id", (count++).toString());
            mxCell1.setAttribute("parent", mxCell0.getAttribute("id"));

            json.boxes.forEach((item, index) => {
                const newCell = doc.createElement("mxCell")
                newCell.setAttribute("id", item.id);
                newCell.setAttribute("parent", mxCell1.getAttribute("id"));
                newCell.setAttribute("value", item.header.caption)
                newCell.setAttribute("vertex", "1")

                const newGeometry = doc.createElement("mxGeometry")
                newGeometry.setAttribute("as", "geometry");
                newGeometry.setAttribute("x", item.header.position.left);
                newGeometry.setAttribute("y", item.header.position.top);
                newGeometry.setAttribute("width", item.header.size.width);
                newGeometry.setAttribute("height", item.header.size.height);


                item.body && Object.keys(item.body).forEach(k => {
                    if (k === "rows") {
                        newCell.setAttribute("style", "shape=table;")
                        newGeometry.setAttribute("width", (60*item.body.rows[0].columns.length).toString());
                        newGeometry.setAttribute("height", (40 + (40 * item.body.rows.length)).toString());

                        item.body.rows.forEach((row, rowIndex) => {
                            const rowCell = doc.createElement("mxCell")
                            rowCell.setAttribute("id", (count++).toString());
                            rowCell.setAttribute("parent", newCell.getAttribute("id"));
                            rowCell.setAttribute("vertex", "1")
                            rowCell.setAttribute("style", "shape=partialRectangle;")


                            const rowGeometry = doc.createElement("mxGeometry")
                            rowGeometry.setAttribute("as", "geometry");
                            rowGeometry.setAttribute("y", (40 + (40 * rowIndex)).toString());
                            rowGeometry.setAttribute("height", "40");
                            rowGeometry.setAttribute("width", (60 * row.columns.length).toString());

                            rowCell.appendChild(rowGeometry)
                            row.columns.forEach((column, columnIndex) => {
                                const columnCell = doc.createElement("mxCell")
                                columnCell.setAttribute("id", column.item.box_id);
                                columnCell.setAttribute("parent", rowCell.getAttribute("id"));
                                columnCell.setAttribute("vertex", "1")
                                columnCell.setAttribute("value", column.item.caption)
                                columnCell.setAttribute("style", "shape=partialRectangle;")


                                const columnGeometry = doc.createElement("mxGeometry")
                                columnGeometry.setAttribute("as", "geometry");
                                columnGeometry.setAttribute("width", "60");
                                columnGeometry.setAttribute("height", "40");
                                columnIndex > 0 && columnGeometry.setAttribute("x", (60 * columnIndex).toString())

                                columnCell.appendChild(columnGeometry)
                                root.appendChild(columnCell)

                            })

                            root.appendChild(rowCell)

                        })

                    }
                })


                newCell.appendChild(newGeometry)
                root.appendChild(newCell)
            })


            const newCell = doc.createElement("mxCell")
            newCell.setAttribute("id", (count++).toString());
            newCell.setAttribute("parent", mxCell1.getAttribute("id"));
            newCell.setAttribute("edge", "1");
            newCell.setAttribute("source", "item1");
            newCell.setAttribute("target", "box_json_example");


            const newGeometry = doc.createElement("mxGeometry")
            newGeometry.setAttribute("as", "geometry");
            newCell.appendChild(newGeometry)


            root.appendChild(newCell)


            root.appendChild(mxCell0);
            root.appendChild(mxCell1);
            customMxGraphModel.appendChild(root);
            doc.appendChild(customMxGraphModel)


            container.innerText = doc.documentElement.outerHTML
            drawGraph(container)
        }

        function drawGraph(container) {
            if (mxClient.isBrowserSupported()) {
                var xml = mxUtils.getTextContent(container);
                var xmlDocument = mxUtils.parseXml(xml);
                if (xmlDocument.documentElement != null && xmlDocument.documentElement.nodeName == 'mxGraphModel') {
                    var decoder = new mxCodec(xmlDocument);
                    var node = xmlDocument.documentElement;

                    container.innerHTML = '';

                    var graph = new mxGraph(container);
                    graph.centerZoom = false;
                    graph.setTooltips(false);
                    graph.setEnabled(false);

                    // Changes the default style for edges "in-place"
                    var style = graph.getStylesheet().getDefaultEdgeStyle();
                    style[mxConstants.STYLE_EDGE] = mxEdgeStyle.ElbowConnector;

                    // Enables panning with left mouse button
                    graph.panningHandler.useLeftButtonForPanning = true;
                    graph.panningHandler.ignoreCell = true;
                    graph.container.style.cursor = 'move';
                    graph.setPanning(true);

                    graph.resizeContainer = true;

                    decoder.decode(node, graph.getModel());
                    graph.resizeContainer = false;

                    // Adds zoom buttons in top, left corner
                    var buttons = document.createElement('div');
                    buttons.style.position = 'absolute';
                    buttons.style.overflow = 'visible';

                    var bs = graph.getBorderSizes();
                    buttons.style.top = (container.offsetTop + bs.y) + 'px';
                    buttons.style.left = (container.offsetLeft + bs.x) + 'px';

                    var left = 0;
                    var bw = 16;
                    var bh = 16;

                    if (mxClient.IS_QUIRKS) {
                        bw -= 1;
                        bh -= 1;
                    }

                    function addButton(label, funct) {
                        var btn = document.createElement('div');
                        mxUtils.write(btn, label);
                        btn.style.position = 'absolute';
                        btn.style.backgroundColor = 'transparent';
                        btn.style.border = '1px solid gray';
                        btn.style.textAlign = 'center';
                        btn.style.fontSize = '10px';
                        btn.style.cursor = 'hand';
                        btn.style.width = bw + 'px';
                        btn.style.height = bh + 'px';
                        btn.style.left = left + 'px';
                        btn.style.top = '0px';

                        mxEvent.addListener(btn, 'click', function (evt) {
                            funct();
                            mxEvent.consume(evt);
                        });

                        left += bw;

                        buttons.appendChild(btn);
                    };

                    addButton('+', function () {
                        graph.zoomIn();
                    });

                    addButton('-', function () {
                        graph.zoomOut();
                    });

                    if (container.nextSibling != null) {
                        container.parentNode.insertBefore(buttons, container.nextSibling);
                    } else {
                        container.appendChild(buttons);
                    }
                }

            }
        }
    </script>

</head>
<body onload="main(document.getElementById('graphContainer'))">

<div id="graphContainer"
     style="cursor:default;position:absolute;top:30px;left:0px;bottom:0px;right:0px;">
</div>

</body>
</html>
