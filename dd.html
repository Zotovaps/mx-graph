<!DOCTYPE html>
<html>

<head>

    <style type="text/css" media="screen">
        body {
            margin: 0;
            padding: 0;

            width: 100vw;
            height: 100vh;
        }
    </style>

    <script type="text/javascript">
        mxBasePath = '../src';
    </script>

    <!-- Loads and initializes the library -->
    <script type="text/javascript" src="../src/js/mxClient.js"></script>
    <script type="text/javascript" src="../js/jsonToXml.js"></script>
    <script type="text/javascript" src="../js/xmlToJson.js"></script>
    <script type="text/javascript" src="../js/custom.js"></script>

    <script type="text/javascript">

        function main(container) {

            if (localStorage.getItem("graph") === null) {
                const json = {
                    "boxes": [
                        {
                            "body": {
                                "rows": [
                                    {
                                        "id": "2",
                                        "type": "row",
                                        "columns": [
                                            {
                                                "item": {
                                                    "type": "column",
                                                    "box_id": "item1",
                                                    "caption": "aaa"
                                                }
                                            },
                                            {
                                                "item": {
                                                    "type": "column",
                                                    "box_id": "item2",
                                                    "caption": "bbb"
                                                }
                                            },
                                            {
                                                "item": {
                                                    "type": "column",
                                                    "box_id": "item3",
                                                    "caption": "ccc",
                                                    "box_links": [
                                                        {
                                                            "link": {
                                                                "typelink": 1,
                                                                "box_id": "box_json_example"
                                                            }
                                                        }
                                                    ]
                                                }
                                            }
                                        ]
                                    },
                                    {
                                        "id": "4",
                                        "type": "row",
                                        "columns": [
                                            {
                                                "item": {
                                                    "type": "column",
                                                    "box_id": "item11",
                                                    "caption": "ddd"
                                                }
                                            },
                                            {
                                                "item": {
                                                    "type": "column",
                                                    "box_id": "item22",
                                                    "caption": "eee"
                                                }
                                            },
                                            {
                                                "item": {
                                                    "type": "column",
                                                    "box_id": "item33",
                                                    "caption": "fff",
                                                    "box_links": [
                                                        {
                                                            "link": {
                                                                "typelink": 1,
                                                                "box_id": "box_json_example"
                                                            }
                                                        }
                                                    ]
                                                }
                                            }
                                        ]
                                    }
                                ]
                            },
                            "type": "table",
                            "id": "box_rows_columns_example",
                            "header": {
                                "position": {
                                    "top": "10",
                                    "left": "100"
                                },
                                "size": {
                                    "width": "180",
                                    "height": "120"
                                },
                                "caption": "Test"
                            }
                        },
                        {
                            "id": "box_json_example",
                            "header": {
                                "position": {
                                    "top": "20",
                                    "left": "420"
                                },
                                "size": {
                                    "width": "150",
                                    "height": "140"
                                },
                                "caption": "Test2"
                            }
                        }
                    ]
                }
                container.innerText = jsonToXml(json)
            }
            else {
                container.innerText = jsonToXml(JSON.parse(localStorage.getItem("graph")))
            }

            console.log(container.innerText)
            drawGraph(container)
        }

        function drawGraph(container) {
            if (mxClient.isBrowserSupported()) {
                var xml = mxUtils.getTextContent(container);
                var xmlDocument = mxUtils.parseXml(xml);
                if (xmlDocument.documentElement != null && xmlDocument.documentElement.nodeName == 'mxGraphModel') {
                    var decoder = new mxCodec(xmlDocument);
                    var node = xmlDocument.documentElement;

                    container.innerHTML = '';

                    var graph = new mxGraph(container);
                    graph.centerZoom = false;
                    graph.setTooltips(false);
                    graph.setEnabled(true);
                    graph.setCellsDisconnectable(false);
                    graph.setAllowDanglingEdges(false);
                    graph.setCellsEditable(false);
                    graph.setConnectable(true);

                    // Enables panning with left mouse button
                    graph.panningHandler.useLeftButtonForPanning = true;
                    // graph.panningHandler.ignoreCell = true;
                    graph.container.style.cursor = 'move';
                    graph.setPanning(true);


                    // graph.resizeContainer = true;
                    // graph.resizeContainer = false;
                    graph.centerZoom = false;



                    // Стили кастомные
                    var style = new Object();
                    style[mxConstants.STYLE_SHAPE] =  mxConstants.SHAPE_SWIMLANE;
                    style[mxConstants.STYLE_FILLCOLOR] = '#FFFFFF';
                    style[mxConstants.STYLE_STROKECOLOR] = '#000000';
                    style[mxConstants.STYLE_FONTCOLOR] = '#000000';
                    style[mxConstants.STYLE_ROUNDED] = true;

                    style[mxConstants.STYLE_VERTICAL_ALIGN] = mxConstants.ALIGN_TOP;
                    style[mxConstants.STYLE_ALIGN] = mxConstants.ALIGN_LEFT;
                    style[mxConstants.STYLE_PERIMETER] = mxPerimeter.EntityPerimeter;
                    style[mxConstants.STYLE_FILLCOLOR] = '#FFFFFF';
                    style[mxConstants.STYLE_STROKECOLOR] = '#D2D7E3';
                    style[mxConstants.STYLE_STROKEWIDTH] = 1;
                    style[mxConstants.STYLE_ROUNDED] = 1;
                    style[mxConstants.STYLE_ABSOLUTE_ARCSIZE] = 1;
                    style[mxConstants.STYLE_ARCSIZE] = "16";
                    style[mxConstants.STYLE_FONTSIZE] = "14";
                    style[mxConstants.STYLE_FONTCOLOR] = "#24293D";


// Используется для меток HTML, которые занимают все пространство вершин
// (см. graph.cellRenderer.redrawLabel ниже для синхронизации размера)
                    style[mxConstants.STYLE_OVERFLOW] = 'fill';

                    graph.getStylesheet().putCellStyle('boxstyle', style);


                    // Changes the default style for edges "in-place"
                    // Использует стиль ребра объекта по умолчанию
                    // (Uses the entity edge style as default)
                    mxMarker.addMarker('custom', function (canvas, shape, type, pe, unitX, unitY, size, source, sw, filled) {
                        var a = size / 2;

                        var pt = pe.clone();
                        pe.x -= unitX * a;
                        pe.y -= unitY * a;

                        return function () {
                            canvas.state.fillColor = "#FFFFFF"
                            canvas.state.strokeWidth = 3

                            canvas.ellipse(pt.x - a, pt.y - a, size, size);

                            if (filled) {
                                canvas.fillAndStroke();
                            } else {
                                canvas.stroke();
                            }
                        };
                    })

                    graph.stylesheet.getDefaultEdgeStyle()[mxConstants.STYLE_EDGE] = mxEdgeStyle.ElbowConnector;
                    graph.stylesheet.getDefaultEdgeStyle()[mxConstants.STYLE_SHAPE] = mxConstants.SHAPE_CONNECTOR;
                    graph.stylesheet.getDefaultEdgeStyle()[mxConstants.STYLE_ROUNDED] = 1;
                    graph.stylesheet.getDefaultEdgeStyle()[mxConstants.STYLE_STROKECOLOR] = '#2D49D7';
                    graph.stylesheet.getDefaultEdgeStyle()[mxConstants.STYLE_FONTCOLOR] = '#446299';
                    graph.stylesheet.getDefaultEdgeStyle()[mxConstants.STYLE_STROKEWIDTH] = 2;
                    graph.stylesheet.getDefaultEdgeStyle()[mxConstants.STYLE_ENDSIZE] = 15;
                    graph.stylesheet.getDefaultEdgeStyle()[mxConstants.STYLE_STARTSIZE] = 15;
                    graph.stylesheet.getDefaultEdgeStyle()[mxConstants.STYLE_ENDARROW] = 'custom';
                    graph.stylesheet.getDefaultEdgeStyle()[mxConstants.STYLE_STARTARROW] = 'custom';





                    decoder.decode(node, graph.getModel());

                    console.log(graph.getChildVertices()[0], "ss")


                    // Adds zoom buttons in top, left corner
                    var buttons = document.createElement('div');
                    buttons.style.position = 'absolute';
                    buttons.style.overflow = 'visible';

                    var bs = graph.getBorderSizes();
                    buttons.style.top = (container.offsetTop + bs.y) + 'px';
                    buttons.style.left = (container.offsetLeft + bs.x) + 'px';

                    var left = 0;
                    var bw = 16;
                    var bh = 16;

                    if (mxClient.IS_QUIRKS) {
                        bw -= 1;
                        bh -= 1;
                    }

                    function addButton(label, funct) {
                        var btn = document.createElement('div');
                        mxUtils.write(btn, label);
                        btn.style.position = 'absolute';
                        btn.style.backgroundColor = 'transparent';
                        btn.style.border = '1px solid gray';
                        btn.style.textAlign = 'center';
                        btn.style.fontSize = '10px';
                        btn.style.cursor = 'hand';
                        btn.style.width = bw + 'px';
                        btn.style.height = bh + 'px';
                        btn.style.left = left + 'px';
                        btn.style.top = '0px';

                        mxEvent.addListener(btn, 'click', function (evt) {
                            funct();
                            mxEvent.consume(evt);
                        });

                        left += bw;

                        buttons.appendChild(btn);
                    };

                    addButton('+', function () {
                        graph.zoomIn();
                    });

                    addButton('-', function () {
                        graph.zoomOut();
                    });

                    addButton('save', function () {
                        var encoder = new mxCodec();
                        var node = encoder.encode(graph.getModel());
                        localStorage.setItem("graph", JSON.stringify(xmlToJson(node)));

                        // mxUtils.popup(mxUtils.getXml(node), true);
                    });


                    if (container.nextSibling != null) {
                        container.parentNode.insertBefore(buttons, container.nextSibling);
                    } else {
                        container.appendChild(buttons);
                    }
                }

            }
        }
    </script>

</head>
<body onload="main(document.getElementById('graphContainer'))">

<div id="graphContainer" style="cursor:default; width: 100%; height: 100%; overflow: hidden;">
</div>

</body>
</html>
